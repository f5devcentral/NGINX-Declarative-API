# HTTP server template

server {
    # {{ s.name }}
    {# --- Listen section start --- #}
    {%- if s.listen -%}
    {% if s.listen.address %}

    listen {{ s.listen.address }}{% if s.listen.tls and s.listen.tls.certificate %} ssl{% endif %};
    {% if s.listen.http2 and s.listen.http2 == True -%}http2 on;{% endif -%}
    {%- endif %}

    {# --- TLS section start --- #}
    {%- if s.listen.tls -%}

    {%- if s.listen.tls.certificate -%}
    ssl_certificate {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.certificate }}.crt;
    {% endif -%}
    {%- if s.listen.tls.key -%}
    ssl_certificate_key {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.key }}.key;
    {% endif -%}
    {% if s.listen.tls.ciphers -%}
    ssl_ciphers {{ s.listen.tls.ciphers }};
    {% endif -%}
    {% if s.listen.tls.protocols -%}
    ssl_protocols{% for p in s.listen.tls.protocols %} {{ p }}{% endfor %};
    {% endif -%}

    {# --- client authentication section --- #}
    {%- if s.listen.tls and s.listen.tls.authentication and s.listen.tls.authentication.client[0] and s.listen.tls.authentication.client[0].profile -%}
    include "{{ ncgconfig.nms.auth_client_dir }}/{{ s.listen.tls.authentication.client[0].profile | replace(" ", "_") }}.conf";
    {% endif %}

    {%- endif %}
    {# --- TLS section end --- #}

    {%- endif -%}
    {# --- Listen section end --- #}

    {# --- njs functions section start - server level --- #}
    {%- if s.njs -%}
    {%- for njshook in s.njs -%}
    {% if njshook.hook.type|lower == "js_set" %}
    {{ njshook.hook.type }} {{ njshook.hook.js_set.variable }} {{ njshook.profile }}.{{ njshook.function }};
    {% elif njshook.hook.type|lower == "js_preload_object" %}
    {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }} {% if njshook.hook.js_preload_object.file %}from {{ njshook.hook.js_preload_object.file }}{% endif%};
    {% elif njshook.hook.type|lower == "js_periodic" %}
    {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }} {% if njshook.hook.js_periodic.interval %}interval={{ njshook.hook.js_periodic.interval }}{% endif%} {% if njshook.hook.js_periodic.jitter %}interval={{ njshook.hook.js_periodic.jitter }}{% endif%} {% if njshook.hook.js_periodic.worker_affinity %}interval={{ njshook.hook.js_periodic.worker_affinity }}{% endif%};
    {% elif njshook.hook.type|lower == "js_body_filter" %}
    {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }} {% if njshook.hook.js_body_filter.buffer_type %}{{ njshook.hook.js_body_filter.buffer_type }}{% endif%};
    {% elif njshook.hook.type|lower == "js_header_filter" %}
    {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }};
    {% elif njshook.hook.type|lower == "js_content" %}
    {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }};
    {% endif %}
    {%- endfor -%}
    {%- endif -%}

    {# --- njs functions section end - server level --- #}

    {% if s.names -%}
    server_name{% for svrname in s.names %} {{ svrname }}{% endfor -%};
    status_zone {{ s.names[0] | replace(" ", "_") }};
    proxy_ssl_server_name on;
    {% endif %}

    {% if s.resolver -%}
    include "{{ ncgconfig.nms.resolver_dir }}/{{ s.resolver | replace(" ", "_") }}.conf";
    {% endif -%}

    {# --- Server NGINX App Protect WAF section start --- #}

    {% if s.app_protect -%}
    {% if s.app_protect.enabled == True -%}
    app_protect_enable on;
    {% endif -%}
    {% if s.app_protect.policy -%}
    app_protect_policy_file {{ ncgconfig.nms.nap_policies_dir_pum }}/{{ s.app_protect.policy }}.tgz;
    {% endif -%}
    {%- if s.app_protect.log -%}
    {%- if s.app_protect.log.enabled == True -%}
    app_protect_security_log_enable on;
    {%- if s.app_protect.log.profile_name -%}
    app_protect_security_log "{{ ncgconfig.nms.nap_logformats_dir_pum }}/{{ s.app_protect.log.profile_name }}.tgz" syslog:server={{ s.app_protect.log.destination }};
    {% endif -%}
    {% endif %}
    {% endif %}
    {% endif %}
    {# --- Server NGINX App Protect WAF section end --- #}

    {# --- HTTP headers manipulation section start --- #}
    {%- if s.headers -%}
    {%- if s.headers.to_server -%}

    {%- if s.headers.to_server.set -%}

    {%- for hSet in s.headers.to_server.set -%}
    proxy_set_header {{ hSet.name }} "{{ hSet.value }}";
    {% endfor -%}
    {%- endif %}
    {% if s.headers.to_server.delete -%}
    {% for hDel in s.headers.to_server.delete -%}
    proxy_set_header {{ hDel }} "";
    {% endfor -%}
    {% endif -%}

    {% endif %}

    {% if s.headers.to_client -%}

    {% if s.headers.to_client.add -%}
    {% for hAdd in s.headers.to_client.add -%}
    add_header {{ hAdd.name }} "{{ hAdd.value }}";
    {% endfor %}
    {% endif %}

    {% if s.headers.to_client.delete -%}
    {% for hDel in s.headers.to_client.delete -%}
    proxy_hide_header {{ hDel }};
    {% endfor %}
    {% endif %}

    {% if s.headers.to_client.replace -%}
    {% for hDel in s.headers.to_client.replace -%}
    proxy_hide_header {{ hDel.name }};
    add_header {{ hDel.name }} "{{ hDel.value }}";
    {% endfor %}
    {% endif %}

    {% endif %}
    {% endif %}

    {# --- HTTP headers manipulation section end --- #}

    {% if s.log.access %}access_log {{ s.log.access.destination }}{% if s.log.access.format %} {{ s.log.access.format }}{% endif %}{% if s.log.access.condition %} if={{ s.log.access.condition }}{% endif %};{% endif %}

    {% if s.log.error %}error_log {{ s.log.error.destination }}{% if s.log.error.level %} {{ s.log.error.level }}{% endif %};{% endif %}

    {# --- Client authentication at server {} level --- #}
    {%- if s.authentication and s.authentication.client -%}
    {%- for clientAuthProfile in s.authentication.client -%}
    {%- set isThisOIDC = namespace(found = False) -%}
    {%- for declClientAuthProfile in declaration.authentication.client -%}
    {%- if declClientAuthProfile.type == "oidc" and declClientAuthProfile.name == clientAuthProfile.profile -%}
    auth_oidc {{ clientAuthProfile.profile | replace(" ", "_") }};
    {%- set isThisOIDC.found = True -%}
    {% endif -%}
    {%- endfor -%}
    {%- if isThisOIDC.found == False -%}
    include "{{ ncgconfig.nms.auth_client_dir }}/{{ clientAuthProfile.profile | replace(" ", "_") }}.conf";
    {%- endif -%}
    {% endfor -%}
    {%- endif -%}

    {# --- Client authorization at server {} level --- #}
    {%- if s.authorization and s.authorization.profile -%}
    include "{{ ncgconfig.nms.authz_client_dir }}/{{ s.authorization.profile | replace(" ", "_") }}.conf";
    {%- endif %}

    {# --- Cache --- #}
    {%- if s.cache -%}
    {%- if s.cache.profile %}proxy_cache {{ s.cache.profile | replace(' ', '_') }};

    {% if s.cache.key %}proxy_cache_key "{{ s.cache.key }}";{% endif %}
    {% endif %}

    {% if s.cache.validity -%}
    {% for validity in s.cache.validity -%}
    proxy_cache_valid {{ validity.code }} {{ validity.ttl }};
    {% endfor %}
    {% endif %}

    {% endif %}

    {% filter indent(width=4) %}
{% if s.snippet and s.snippet.content %}{{ s.snippet.content | b64decode }}{% endif %}
    {% endfilter %}

    {# --- Server location section start --- #}
    {% for loc in s.locations %}

    location
    {%- if loc.urimatch -%}
    {# location URI match types: prefix (default), exact (=), casesens_regex (~), caseinsens_regex (~*), best_nonregex (^~) #}
    {%- if loc.urimatch|lower == "prefix" %} {% endif %}
    {%- if loc.urimatch|lower == "exact" %} = {% endif %}
    {%- if loc.urimatch|lower == "regex" %} ~ {% endif %}
    {%- if loc.urimatch|lower == "iregex" %} ~* {% endif %}
    {%- if loc.urimatch|lower == "best" %} ^~ {% endif %}
    {%- endif -%}
    {{ loc.uri }} {
        {% if loc.authentication and loc.authentication.server and loc.authentication.server[0].profile -%}
        include "{{ ncgconfig.nms.auth_server_dir }}/{{ loc.authentication.server[0].profile | replace(" ", "_") }}.conf";
        {% endif %}

        {% if loc.upstream %}proxy_pass {{ loc.upstream }};{% endif %}

        {% if loc.log.access %}access_log {{ loc.log.access.destination }}{% if loc.log.access.format %} {{ loc.log.access.format }}{% endif %}{% if loc.log.access.condition %} if={{ loc.log.access.condition }}{% endif %};{% endif %}

        {% if loc.log.error %}error_log {{ loc.log.error.destination }}{% if loc.log.error.level %} {{ loc.log.error.level }}{% endif %};{% endif %}

        {# --- Active healthchecks --- #}

        {% if loc.health_check -%}
            {% if loc.health_check.enabled == True -%}
            health_check{% if loc.health_check.uri %} uri={{ loc.health_check.uri }}{% endif %}{% if loc.health_check.interval %} interval={{ loc.health_check.interval }}{% endif %}{% if loc.health_check.fails %} fails={{ loc.health_check.fails }}{% endif %}{% if loc.health_check.passes %} passes={{ loc.health_check.passes }}{% endif %};
            {% endif %}
        {% endif %}

        {# --- njs functions section start - location level --- #}
        {%- if loc.njs -%}
        {%- for njshook in loc.njs -%}
        {% if njshook.hook.type|lower == "js_set" %}
        {{ njshook.hook.type }} {{ njshook.hook.js_set.variable }} {{ njshook.profile }}.{{ njshook.function }};
        {% elif njshook.hook.type|lower == "js_preload_object" %}
        {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }} {% if njshook.hook.js_preload_object.file %}from {{ njshook.hook.js_preload_object.file }}{% endif%};
        {% elif njshook.hook.type|lower == "js_periodic" %}
        {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }} {% if njshook.hook.js_periodic.interval %}interval={{ njshook.hook.js_periodic.interval }}{% endif%} {% if njshook.hook.js_periodic.jitter %}interval={{ njshook.hook.js_periodic.jitter }}{% endif%} {% if njshook.hook.js_periodic.worker_affinity %}interval={{ njshook.hook.js_periodic.worker_affinity }}{% endif%};
        {% elif njshook.hook.type|lower == "js_body_filter" %}
        {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }} {% if njshook.hook.js_body_filter.buffer_type %}{{ njshook.hook.js_body_filter.buffer_type }}{% endif%};
        {% elif njshook.hook.type|lower == "js_header_filter" %}
        {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }};
        {% elif njshook.hook.type|lower == "js_content" %}
        {{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }};
        {% endif %}
        {%- endfor -%}
        {%- endif -%}

        {# --- njs functions section end - server level --- #}

        {# --- HTTP headers manipulation section @ location start --- #}
        {%- if loc.headers -%}
        {% if loc.headers.to_server -%}

        {% if loc.headers.to_server.set -%}
        {% for hSet in loc.headers.to_server.set -%}
        proxy_set_header {{ hSet.name }} "{{ hSet.value }}";
        {% endfor %}
        {% endif %}

        {% if loc.headers.to_server.delete -%}
        {% for hDel in loc.headers.to_server.delete -%}
        proxy_set_header {{ hDel }} "";
        {% endfor %}
        {% endif %}

        {% endif %}

        {% if loc.headers.to_client -%}

        {% if loc.headers.to_client.add -%}
        {% for hAdd in loc.headers.to_client.add -%}
        add_header {{ hAdd.name }} "{{ hAdd.value }}";
        {% endfor %}
        {% endif %}

        {% if loc.headers.to_client.delete -%}
        {% for hDel in loc.headers.to_client.delete -%}
        proxy_hide_header {{ hDel }};
        {% endfor %}
        {% endif %}

        {% if loc.headers.to_client.replace -%}
        {% for hDel in loc.headers.to_client.replace -%}
        proxy_hide_header {{ hDel.name }};
        add_header {{ hDel.name }} "{{ hDel.value }}";
        {% endfor %}
        {% endif %}

        {% endif %}
        {% endif %}
        {# --- HTTP headers manipulation section @ location end --- #}

        {# --- Rate limiting --- #}

        {% if loc.rate_limit -%}
        {% if loc.rate_limit.profile %}limit_req zone={{ loc.rate_limit.profile }}{% if loc.rate_limit.burst %} burst={{ loc.rate_limit.burst }}{% endif %}{% if loc.rate_limit.delay == 0 %} nodelay;{% else %} delay={{ loc.rate_limit.delay }};{% endif %}

        {% if loc.rate_limit.httpcode %}limit_req_status {{ loc.rate_limit.httpcode }};{% endif %}{% endif %}
        {% endif %}

        {# --- Cache --- #}
        {%- if loc.cache -%}
        {%- if loc.cache.profile %}proxy_cache {{ loc.cache.profile | replace(' ', '_') }};

        {% if loc.cache.key %}proxy_cache_key "{{ loc.cache.key }}";{% endif %}
        {% endif %}

        {% if loc.cache.validity -%}
        {% for validity in loc.cache.validity -%}
        proxy_cache_valid {{ validity.code }} {{ validity.ttl }};
        {% endfor %}
        {% endif %}

        {% endif %}

        {# --- Client authentication at location level --- #}
        {%- if loc.authentication and loc.authentication.client -%}
        {%- for clientAuthProfile in loc.authentication.client -%}
        {%- set isThisOIDC = namespace(found = False) -%}
        {%- for declClientAuthProfile in declaration.authentication.client -%}
        {%- if declClientAuthProfile.type == "oidc" and declClientAuthProfile.name == clientAuthProfile.profile -%}
        auth_oidc {{ clientAuthProfile.profile | replace(" ", "_") }};
        {%- set isThisOIDC.found = True -%}
        {% endif -%}
        {%- endfor -%}
        {%- if isThisOIDC.found == False -%}
        include "{{ ncgconfig.nms.auth_client_dir }}/{{ clientAuthProfile.profile | replace(" ", "_") }}.conf";
        {%- endif -%}
        {% endfor -%}
        {%- endif -%}

        {# --- Client authorization at location level --- #}
        {%- if loc.authorization and loc.authorization.profile -%}
        include "{{ ncgconfig.nms.authz_client_dir }}/{{ loc.authorization.profile | replace(" ", "_") }}.conf";
        {%- endif -%}

        {# --- Location NGINX App Protect WAF --- #}

        {% if loc.app_protect -%}
        {% if loc.app_protect.enabled == True -%}
        app_protect_enable on;
        {% endif -%}
        {% if loc.app_protect.policy -%}
        app_protect_policy_file {{ ncgconfig.nms.nap_policies_dir_pum }}/{{ loc.app_protect.policy }}.tgz;
        {% endif %}
        {% if loc.app_protect.log -%}
        {%- if loc.app_protect.log.enabled == True -%}
        app_protect_security_log_enable on;
        {% if loc.app_protect.log.profile_name -%}
        app_protect_security_log "{{ ncgconfig.nms.nap_logformats_dir_pum }}/{{ loc.app_protect.log.profile_name }}.tgz" syslog:server={{ loc.app_protect.log.destination }};
        {% endif %}
        {% endif %}
        {% endif %}
        {% endif %}

        {% if loc.apigateway and loc.apigateway.api_gateway.enabled == True %}
        include "{{ ncgconfig.nms.apigw_dir }}/{{ s.names[0] }}{{ loc.uri }}.conf";
        {% endif %}

        {# --- Location snippets --- #}
        {% if loc.snippet and loc.snippet.content %}{{ loc.snippet.content | b64decode }}{% endif %}

    }
    {% endfor %}

    {# --- JWT authentication JWKS endpoints --- #}
    {%- if declaration.authentication and declaration.authentication.client -%}
    {%- for clientAuthProfile in declaration.authentication.client -%}
    {%- if clientAuthProfile.type == "jwt" -%}
    include "{{ ncgconfig.nms.auth_client_dir }}/jwks_{{ clientAuthProfile.name | replace(" ", "_") }}.conf";
    {% endif -%}
    {%- endfor -%}
    {%- endif %}

}