# NGINX configuration file - HTTP servers - generated by https://github.com/f5devcentral/NGINX-Declarative-API

{# --- njs import section --- #}
{% if declaration.njs_profiles %}
js_path "{{ ncgconfig.nms.njs_dir }}";
{% for njsp in declaration.njs_profiles %}
js_import {{ njsp.name | replace(" ", "_") }} from {{ njsp.name | replace(" ", "_") }}.js;
{% endfor %}
{% endif %}

{# --- njs functions section - HTTP level --- #}
{% if declaration.njs %}
{% for njshook in declaration.njs %}
{% if njshook.hook.type|lower == "js_set" %}
{{ njshook.hook.type }} {{ njshook.hook.js_set.variable }} {{ njshook.profile }}.{{ njshook.function }};
{% elif njshook.hook.type|lower == "js_preload_object" %}
{{ njshook.hook.type }} {{ njshook.profile }}.{{ njshook.function }} {% if njshook.hook.js_preload_object.file %}from {{ njshook.hook.js_preload_object.file }}{% endif%};
{% endif %}
{% endfor %}
{% endif %}

{# --- DNS resolver --- #}
{% if declaration.resolver -%}
include "{{ ncgconfig.nms.resolver_dir }}/{{ declaration.resolver | replace(" ", "_") }}.conf";
{% endif -%}

{# --- OpenID Connect providers --- #}
# OpenID Connect profiles
include "{{ ncgconfig.nms.auth_client_dir }}/oidc/*.conf";

{# --- ACME issuers shared zone --- #}
{% if declaration.acme_issuers %}
# ACME issuers shared memory zone
acme_shared_zone zone=ngx_acme_shared:1M;

{%- for i in declaration.acme_issuers -%}
include "{{ ncgconfig.nms.acme_dir }}/{{ i.name | replace(" ", "_") }}.conf";
{%- endfor -%}

server {
  # listener on port 80 is required to process ACME HTTP-01 challenges
  listen 80;

  location / {
    return 404;
  }
}
{%- endif -%}

{# --- Maps section --- #}

{%- if declaration.maps %}
{% for m in declaration.maps %}

map {{ m.match }} {{ m.variable }} {
    {% for e in m.entries %}
        {%- if e.keymatch|lower == "exact" %}{% endif -%}
        {%- if e.keymatch|lower == "regex" %} ~^ {%- endif -%}
        {%- if e.keymatch|lower == "iregex" %} ~*^ {%- endif -%}
        {{ e.key }} {{ e.value }};
    {% endfor -%}

}
{% endfor %}
{% endif %}

{# --- Maps section for authorization --- #}
{%- if declaration.authorization -%}
# Authorization profiles
variables_hash_bucket_size 512;
map_hash_bucket_size 256;
{% for authzprofile in declaration.authorization -%}
include "{{ ncgconfig.nms.authz_client_dir }}/{{ authzprofile.name | replace(" ", "_") }}.maps.conf";
{% endfor -%}
{%- endif -%}

{# --- Maps section for API Gateway parameters enforcement --- #}

# API Gateway parameter enforcement maps
include "{{ ncgconfig.nms.apigw_maps_dir }}/*.conf";

{# --- Snippets section --- #}
{% if declaration.snippet and declaration.snippet.content %}{{ declaration.snippet.content | b64decode }}{% endif %}


{# --- Upstreams section --- #}
{% if declaration.upstreams %}
# Upstreams
{% for u in declaration.upstreams %}
{% if u.name %}
include "{{ ncgconfig.nms.upstream_http_dir }}/{{ u.name | replace(' ', '_') }}.conf";
{% endif %}
{% endfor %}
{% endif %}

{# --- Rate limit section --- #}
{% if declaration.rate_limit %}
# Rate limiting zones
{% for rl in declaration.rate_limit %}
limit_req_zone {{ rl.key }} zone={{ rl.name | replace(' ', '_') }}:{{ rl.size }} rate={{ rl.rate }};
{% endfor %}
{% endif %}

{# --- Cache section --- #}
{% if declaration.cache %}
# Cache zones
{% for c in declaration.cache %}
proxy_cache_path {{ c.basepath }}/{{ c.name | replace(' ', '_') }} levels=1:2 keys_zone={{ c.name | replace(' ', '_') }}:{{ c.ttl }}  max_size={{ c.size }};
{% endfor %}
{% endif -%}

{# --- Visibility integration section --- #}
# Visibility integrations
include "{{ ncgconfig.nms.visibility_dir }}/*-http.conf";

{# --- Server section for NGINX Plus API --- #}

{% if declaration.nginx_plus_api %}
{% if declaration.nginx_plus_api.listen %}
server {
    listen {{ declaration.nginx_plus_api.listen }};

    location /api {
        {% if declaration.nginx_plus_api.write == True %}api write=on;{% else %}api write=off;{% endif %}

        {% if declaration.nginx_plus_api.allow_acl -%}
        allow {{ declaration.nginx_plus_api.allow_acl }};
        deny all;
        {% else %}
        allow all;
        {% endif %}

    }

    location / {
        root /usr/share/nginx/html;
        index dashboard.html;
    }
}
{% endif %}
{% endif %}

{# --- Server section --- #}

{% for s in declaration.servers %}
include "{{ ncgconfig.nms.server_http_dir }}/{{ s.name | replace(' ', '_') }}.conf";
{% endfor -%}