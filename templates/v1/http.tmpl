# NGINX configuration file - HTTP servers - generated by https://github.com/fabriziofiorucci/NGINX-Config-Generator

{# --- Maps section --- #}

{% if declaration.maps %}
{% for m in declaration.maps %}
map {{ m.match }} {{ m.variable }} {
    {% for e in m.entries %}
    {%- if e.keymatch|lower == "exact" %}{% endif -%}
    {%- if e.keymatch|lower == "regex" %} ~^ {%- endif -%}
    {%- if e.keymatch|lower == "iregex" %} ~*^ {%- endif -%}
    {{ e.key }} {{ e.value }};
    {% endfor -%}

}
{% endfor %}
{% endif %}

{# --- Snippets section --- #}
{% if declaration.snippet %}{{ declaration.snippet | b64decode }}{% endif %}


{# --- Upstreams section --- #}
{% if declaration.upstreams %}
{% for u in declaration.upstreams %}
upstream {{ u.name }} {
    zone {{ u.name }} 64k;
    {% for o in u.origin -%}
    server {{ o.server }}{% if o.weight %} weight={{ o.weight }}{% endif %}{% if o.max_fails %} max_fails={{ o.max_fails }}{% endif %}{% if o.fail_timeout %} fail_timeout={{ o.fail_timeout }}{% endif %}{% if o.max_conns %} max_conns={{ o.max_conns }}{% endif %}{% if o.slow_start %} slow_start={{ o.slow_start }}{% endif %}{% if o.backup and o.backup == True %} backup{% endif %};
    {% endfor %}

    {% if u.sticky -%}
    sticky cookie {{ u.sticky.cookie }}{% if u.sticky.expires %} expires={{ u.sticky.expires }}{% endif %}{% if u.sticky.domain %} domain={{ u.sticky.domain }}{% endif %}{% if u.sticky.path %} path={{ u.sticky.path }}{% endif %};
    {% endif -%}

    {% if u.snippet %}{{ u.snippet | b64decode }}{% endif %}

}
{% endfor %}
{% endif %}

{# --- Rate limit section --- #}

{% if declaration.rate_limit %}
{% for rl in declaration.rate_limit %}
limit_req_zone {{ rl.key }} zone={{ rl.name }}:{{ rl.size }} rate={{ rl.rate }};
{% endfor %}
{% endif %}

{# --- Server section for NGINX Plus API --- #}

{% if declaration.nginx_plus_api %}
server {
    listen {{ declaration.nginx_plus_api.listen }};

    location /api {
        {% if declaration.nginx_plus_api.write == True %}api write=on;{% else %}api write=off;{% endif %}

        {% if declaration.nginx_plus_api.allow_acl -%}
        allow {{ declaration.nginx_plus_api.allow_acl }};
        deny all;
        {% else %}
        allow all;
        {% endif %}

    }

    location / {
        root /usr/share/nginx/html;
        index dashboard.html;
    }
}
{% endif %}

{# --- Server section --- #}

{% for s in declaration.servers %}
server {
    {% if s.listen -%}
    listen {{ s.listen.address }}{% if s.listen.http2 and s.listen.http2 == True %} http2{% endif %}{% if s.listen.tls %} ssl{% endif %};
    {% endif -%}
    server_name{% for svrname in s.names %} {{ svrname }}{% endfor -%};
    status_zone {{ s.names[0] }};

    {% if s.app_protect -%}
    app_protect_enable {% if s.app_protect.enabled == True %}on{% else %}off{% endif %};
    app_protect_policy_file {{ ncgconfig.nms.nap_policies_dir }}/{{ s.app_protect.policy }}.json;
    {% if s.app_protect.log -%}
    app_protect_security_log_enable {% if s.app_protect.log.enabled == True %}on;
    app_protect_security_log "{{ ncgconfig.nms.nap_logformats_dir }}/{{ s.app_protect.log.profile_name }}.json" syslog:server={{ s.app_protect.log.destination }};
    {% else %}off;{% endif %}
    {% endif %}
    {% endif %}

    {# --- TLS section --- #}
    {%- if s.listen.tls -%}
    ssl_certificate {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.certificate }}.crt;
    ssl_certificate_key {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.key }}.key;
    {% endif -%}
    {% if s.listen.tls.chain -%}
    ssl_trusted_certificate {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.chain }}.chain;
    {% endif -%}
    {% if s.listen.tls.ciphers -%}
    ssl_ciphers {{ s.listen.tls.ciphers }};
    {% endif -%}
    {% if s.listen.tls.protocols -%}
    ssl_protocols{% for p in s.listen.tls.protocols %} {{ p }}{% endfor %};
    {% endif %}

    {% if s.log.access %}access_log {{ s.log.access }} main;{% endif %}

    {% if s.log.error %}error_log {{ s.log.error }};{% endif %}


    {% if s.snippet %}{{ s.snippet | b64decode }}{% endif %}

    {% for loc in s.locations %}

    {# --- Server location section --- #}

    location
    {%- if loc.urimatch -%}
    {# location URI match types: prefix (default), exact (=), casesens_regex (~), caseinsens_regex (~*), best_nonregex (^~) #}
    {%- if loc.urimatch|lower == "prefix" %} {% endif -%}
    {%- if loc.urimatch|lower == "exact" %} = {% endif -%}
    {%- if loc.urimatch|lower == "regex" %} ~ {% endif -%}
    {%- if loc.urimatch|lower == "iregex" %} ~* {% endif -%}
    {%- if loc.urimatch|lower == "best" %} ^~ {% endif -%}
    {%- endif -%}
    {{ loc.uri }} {
        {% if loc.upstream %}proxy_pass {{ loc.upstream }};{% endif %}

        {% if loc.health_check -%}
            {% if loc.health_check.enabled == True -%}
            health_check{% if loc.health_check.uri %} uri={{ loc.health_check.uri }}{% endif %}{% if loc.health_check.interval %} interval={{ loc.health_check.interval }}{% endif %}{% if loc.health_check.fails %} fails={{ loc.health_check.fails }}{% endif %}{% if loc.health_check.passes %} passes={{ loc.health_check.passes }}{% endif %};
            {% endif %}
        {% endif %}

        {% if loc.rate_limit -%}
        {% if loc.rate_limit.profile %}limit_req zone={{ loc.rate_limit.profile }}{% if loc.rate_limit.burst %} burst={{ loc.rate_limit.burst }}{% endif %}{% if loc.rate_limit.delay == 0 %} nodelay;{% else %} delay={{ loc.rate_limit.delay }};{% endif %}{% endif %}
        {% endif %}

        {% if loc.app_protect -%}
        app_protect_enable {% if loc.app_protect.enabled == True %}on{% else %}off{% endif %};
        app_protect_policy_file {{ ncgconfig.nms.nap_policies_dir }}/{{ loc.app_protect.policy }}.json;
        {% if loc.app_protect.log -%}
        app_protect_security_log_enable {% if loc.app_protect.log.enabled == True %}on;
        app_protect_security_log "{{ ncgconfig.nms.nap_logformats_dir }}/{{ loc.app_protect.log.profile_name }}.json" syslog:server={{ loc.app_protect.log.destination }};
        {% else %}off;{% endif %}
        {% endif %}
        {% endif %}

        {% if loc.snippet %}{{ loc.snippet | b64decode }}{% endif %}

    }
    {% endfor %}

}

{% endfor %}