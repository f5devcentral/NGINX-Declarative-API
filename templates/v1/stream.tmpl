# NGINX configuration file - Stream servers - generated by https://github.com/fabriziofiorucci/NGINX-Declarative-API

{# --- Upstreams section --- #}

{% if declaration.upstreams %}
{% for u in declaration.upstreams %}
upstream {{ u.name }} {
    zone {{ u.name }} 64k;
    {% for o in u.origin -%}
    server {{ o.server }}{% if o.weight %} weight={{ o.weight }}{% endif %}{% if o.max_fails %} max_fails={{ o.max_fails }}{% endif %}{% if o.fail_timeout %} fail_timeout={{ o.fail_timeout }}{% endif %}{% if o.max_conns %} max_conns={{ o.max_conns }}{% endif %}{% if o.slow_start %} slow_start={{ o.slow_start }}{% endif %}{% if o.backup and o.backup == True %} backup{% endif %};
    {% endfor %}

    {% if u.snippet %}{{ u.snippet }}{% endif %}

}
{% endfor %}
{% endif %}


{# --- Stream server section --- #}

{% for s in declaration.servers %}
server {
    {% if s.listen -%}
    listen {{ s.listen.address }}{% if s.listen.protocol == "udp" %} {{ s.listen.protocol }}{% endif %};
    {% endif %}

    status_zone {{ s.listen.address }}{% if s.listen.protocol == "udp" %}-{{ s.listen.protocol }}{% endif %};

    {# --- TLS section --- #}
    {%- if s.listen.tls -%}
    ssl_certificate {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.certificate }}.crt;
    ssl_certificate_key {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.key }}.key;
    {% endif -%}
    {% if s.listen.tls.chain -%}
    ssl_trusted_certificate {{ ncgconfig.nms.certs_dir }}/{{ s.listen.tls.chain }}.chain;
    {% endif -%}
    {% if s.listen.tls.ciphers -%}
    ssl_ciphers {{ s.listen.tls.ciphers }};
    {% endif -%}
    {% if s.listen.tls.protocols -%}
    ssl_protocols{% for p in s.listen.tls.protocols %} {{ p }}{% endfor %};
    {% endif %}

    {% if s.upstream -%}
    proxy_pass {{ s.upstream }};
    {% endif %}

    {% if s.snippet %}{{ s.snippet | b64decode }}{% endif %}

}

{% endfor %}
